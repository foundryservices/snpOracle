# Use an Ubuntu base image
FROM ubuntu:20.04

# Avoid prompts from apt
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y \
    make build-essential git clang curl libssl-dev llvm libudev-dev protobuf-compiler \
    python3 python3-pip

# Install Rust and Cargo
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

# Clone subtensor repository
RUN git clone https://github.com/opentensor/subtensor.git

# Setup Rust for subtensor
WORKDIR /subtensor
RUN ./scripts/init.sh

# Build subtensor binary
RUN cargo build -p node-subtensor --profile production --features pow-faucet

# Clone bittensor subnet template
WORKDIR /
RUN git clone https://github.com/opentensor/bittensor-subnet-template.git

# Install Python dependencies
WORKDIR /bittensor-subnet-template
RUN pip3 install -e .

# Copy setup scripts
COPY setup_wallets.sh /setup_wallets.sh
COPY run_local_network.sh /run_local_network.sh

# Make scripts executable
RUN chmod +x /setup_wallets.sh /run_local_network.sh

# Set entrypoint
ENTRYPOINT ["/run_local_network.sh"]
